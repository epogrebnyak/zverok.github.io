<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>class Ractor - RDoc Documentation</title>
<script type="text/javascript">
  var rdoc_rel_prefix = "./";
  var index_rel_prefix = "./";
</script>

<script src="./js/jquery.js"></script>
<script src="./js/darkfish.js"></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>


<div class="nav-section">
  <h3>Table of Contents</h3>

  <ul class="link-list" role="directory">
    <li><a href="#class-Ractor-label-Shareable+and+unshareable+objects">Shareable and unshareable objects</a>
    <li><a href="#class-Ractor-label-Ractors+vs+threads">Ractors vs threads</a>
  </ul>
</div>


  <div id="class-metadata">

    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>


  <p class="link"><a href="Object.html">Object</a>

</div>



    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">

    <li ><a href="#method-c-count">::count</a>

    <li ><a href="#method-c-current">::current</a>

    <li ><a href="#method-c-make_shareable">::make_shareable</a>

    <li ><a href="#method-c-new">::new</a>

    <li ><a href="#method-c-receive">::receive</a>

    <li ><a href="#method-c-recv">::recv</a>

    <li ><a href="#method-c-select">::select</a>

    <li ><a href="#method-c-shareable-3F">::shareable?</a>

    <li ><a href="#method-c-yield">::yield</a>

    <li ><a href="#method-i-3C-3C">#&lt;&lt;</a>

    <li ><a href="#method-i-close_incoming">#close_incoming</a>

    <li ><a href="#method-i-close_outgoing">#close_outgoing</a>

    <li ><a href="#method-i-name">#name</a>

    <li ><a href="#method-i-recv">#recv</a>

    <li ><a href="#method-i-send">#send</a>

    <li ><a href="#method-i-take">#take</a>

  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-Ractor">
  <h1 id="class-Ractor" class="class">
    class Ractor
  </h1>

  <section class="description">

<p><a href="Ractor.html"><code>Ractor</code></a> is a Thread-alike object that provides thread-safety by design.</p>

<p>Before <a href="Ractor.html"><code>Ractor</code></a> introduction, Ruby had one Global Virtual Machine Lock (GVL) per process, which only one <a href="Thread.html"><code>Thread</code></a> at a time could possess, therefore prohibiting true concurrency.</p>

<p>Since Ruby 3.0, Ruby has one GVL <em>per ractor</em> (including the main ractor, which is implicit), and different ractors can be performed truly in parallel.</p>

<p>To achieve this, ractors severely limit data sharing between different ractors. Unlike threads, ractors can&#39;t access each other&#39;s data, nor the data in the outer scope.</p>

<pre class="ruby"><span class="ruby-comment"># The simplest ractor</span>
<span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> { <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;I am in Ractor!&quot;</span> }
<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>) <span class="ruby-comment"># allow it to finish</span>
<span class="ruby-comment"># here &quot;I am in Ractor!&quot; would be printed</span>

<span class="ruby-identifier">a</span> = <span class="ruby-value">1</span>
<span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> { <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;I am in Ractor! a=#{a}&quot;</span> }
<span class="ruby-comment"># fails immediately with</span>
<span class="ruby-comment"># ArgumentError (can not isolate a Proc because it accesses outer variables (a).)</span>
</pre>

<p>Instead of accessing the shared state, the data should be passed to and from ractors via sending and receiving messages, thus making them <em>actors</em> (“Ractor” stands for “Ruby Actor”).</p>

<pre class="ruby"><span class="ruby-identifier">a</span> = <span class="ruby-value">1</span>
<span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> {
  <span class="ruby-identifier">a_in_ractor</span> = <span class="ruby-identifier">receive</span> <span class="ruby-comment"># receive blocks till somebody will pass message</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;I am in Ractor! a=#{a_in_ractor}&quot;</span>
}
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">a</span>)  <span class="ruby-comment"># pass it</span>
<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)
<span class="ruby-comment"># here &quot;I am in Ractor! a=1&quot; would be printed</span>
</pre>

<p>There are two pairs of methods for sending/receiving messages:</p>
<ul><li>
<p><a href="Ractor.html#method-i-send"><code>Ractor#send</code></a> and <a href="Ractor.html#method-c-receive"><code>Ractor.receive</code></a> for when the <em>sender</em> knows the receiver (push);</p>
</li><li>
<p><a href="Ractor.html#method-c-yield"><code>Ractor.yield</code></a> and <a href="Ractor.html#method-i-take"><code>Ractor#take</code></a> for when the <em>receiver</em> knows the sender (pull);</p>
</li></ul>

<p>In addition to that, an argument to <a href="Ractor.html#method-c-new"><code>Ractor.new</code></a> would be passed to block and available there as if received by <a href="Ractor.html#method-c-receive"><code>Ractor.receive</code></a>, and the last block value would be sent outside of the ractor as if sent by <a href="Ractor.html#method-c-yield"><code>Ractor.yield</code></a>.</p>

<p>A little demonstration on a classic ping-pong:</p>

<pre class="ruby"><span class="ruby-identifier">server</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Server starts: #{self.inspect}&quot;</span>
  <span class="ruby-string">&quot;Server sends: ping&quot;</span>
  <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">yield</span> <span class="ruby-string">&#39;ping&#39;</span>                       <span class="ruby-comment"># The server doesn&#39;t know the receiver and sends to whoever interested</span>
  <span class="ruby-identifier">received</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">_receive</span>                <span class="ruby-comment"># The server doesn&#39;t know the sender and receives from whoever sent</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Server received: #{received}&quot;</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">client</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">server</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">srv</span><span class="ruby-operator">|</span>        <span class="ruby-comment"># The server is sent inside client, and available as srv</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Client starts: #{self.inspect}&quot;</span>
  <span class="ruby-identifier">received</span> = <span class="ruby-identifier">srv</span>.<span class="ruby-identifier">take</span>                       <span class="ruby-comment"># The Client takes a message specifically from the server</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Client received from &quot;</span> \
       <span class="ruby-node">&quot;#{srv.inspect}: #{received}&quot;</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Client sends to &quot;</span> \
       <span class="ruby-node">&quot;#{srv.inspect}: pong&quot;</span>
  <span class="ruby-identifier">srv</span>.<span class="ruby-identifier">send</span> <span class="ruby-string">&#39;pong&#39;</span>                           <span class="ruby-comment"># The client sends a message specifically to the server</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)
</pre>

<p>This will output:</p>

<pre>Server starts: #&lt;Ractor:#2 test.rb:1 running&gt;
Client starts: #&lt;Ractor:#3 test.rb:8 running&gt;
Client received from #&lt;Ractor:#2 rac.rb:1 blocking&gt;: ping
Client sends to #&lt;Ractor:#2 rac.rb:1 blocking&gt;: pong
Server received: pong</pre>

<p>It is said that <a href="Ractor.html"><code>Ractor</code></a> receives messages via the <em>incoming port</em>, and sends them to the <em>outgoing port</em>. Either one can be disabled with <a href="Ractor.html#method-i-close_incoming"><code>Ractor.close_incoming</code></a> and <a href="Ractor.html#method-i-close_outgoing"><code>Ractor.close_outgoing</code></a> respectively.</p>

<h2 id="class-Ractor-label-Shareable+and+unshareable+objects">Shareable and unshareable objects<span><a href="#class-Ractor-label-Shareable+and+unshareable+objects">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>When the object is sent to and from the ractor, it is important to understand whether the object is shareable or not. Shareable objects are basically those which can be used by several threads without compromising thread-safety; e.g. immutable ones. <a href="Ractor.html#method-c-shareable-3F"><code>Ractor.shareable?</code></a> allows to check this, and <a href="Ractor.html#method-c-make_shareable"><code>Ractor.make_shareable</code></a> tries to make object shareable if it is not.</p>

<pre class="ruby"><span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">shareable?</span>(<span class="ruby-value">1</span>)        <span class="ruby-comment">#=&gt; true -- numbers and other immutable basic values are</span>
<span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">shareable?</span>(<span class="ruby-string">&#39;foo&#39;</span>)    <span class="ruby-comment">#=&gt; true or false, depending on whether you have freeze_string_literals: true</span>
<span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">shareable?</span>(<span class="ruby-string">-&#39;foo&#39;</span>)   <span class="ruby-comment">#=&gt; true</span>
<span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">shareable?</span>(<span class="ruby-string">+&#39;foo&#39;</span>)   <span class="ruby-comment">#=&gt; false</span>

<span class="ruby-identifier">str</span> = <span class="ruby-string">+&#39;foo&#39;</span>
<span class="ruby-identifier">str</span>.<span class="ruby-identifier">frozen?</span>                 <span class="ruby-comment">#=&gt; false</span>
<span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">make_shareable</span>(<span class="ruby-identifier">str</span>)
<span class="ruby-identifier">str</span>.<span class="ruby-identifier">frozen?</span>                 <span class="ruby-comment">#=&gt; true</span>
</pre>

<p>When a shareable object is sent (via <a href="Ractor.html#method-i-send"><code>send</code></a> or <a href="Ractor.html#method-c-yield"><code>Ractor.yield</code></a>), no additional processing happens, and it just becomes usable by both ractors. When an unshareable object is sent, it can be either <em>copied</em> or <em>moved</em>. The first is the default, and it makes the object&#39;s full copy by dumping and loading it with <a href="Marshal.html"><code>Marshal</code></a>.</p>

<pre class="ruby"><span class="ruby-identifier">data</span> = [<span class="ruby-string">+&#39;foo&#39;</span>, <span class="ruby-string">+&#39;bar&#39;</span>]
<span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">data</span>){
  <span class="ruby-identifier">data_in_ractor</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">receive</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;In ractor: #{data_in_ractor.object_id}, #{data_in_ractor[0].object_id}&quot;</span>
}
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">data</span>, <span class="ruby-value">move:</span> <span class="ruby-keyword">true</span>)
<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)
<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Outside: #{data.object_id}, #{data[0].object_id}&quot;</span>
</pre>

<p>This will output:</p>

<pre>In ractor: 100, 120
Outside: 60, 80</pre>

<p>(Note that object id of both array and string inside array have changed inside the ractor, showing it is different objects.)</p>

<p>Dumping data with <a href="Marshal.html"><code>Marshal</code></a> may be slow, and sometimes impossible. Alternatively, <code>move: true</code> may be used on sending. This will <em>move</em> the object to the receiving ractor, making it inaccessible for a sending ractor.</p>

<pre class="ruby"><span class="ruby-identifier">data</span> = [<span class="ruby-string">+&#39;foo&#39;</span>, <span class="ruby-string">+&#39;bar&#39;</span>]
<span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span>{
  <span class="ruby-identifier">data_in_ractor</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">receive</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;In ractor: #{data_in_ractor.object_id}, #{data_in_ractor[0].object_id}&quot;</span>
}
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">data</span>, <span class="ruby-value">move:</span> <span class="ruby-keyword">true</span>)
<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)
<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Outside: moved? #{Ractor::MovedObject === data}&quot;</span>
<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Outside: #{data.inspect}&quot;</span>
</pre>

<p>This will output:</p>

<pre>In ractor: 100, 120
Outside: moved? true
test.rb:9:in `method_missing&#39;: can not send any methods to a moved object (Ractor::MovedError)</pre>

<p>Notice that even <code>inspect</code> (and more basic methods like <code>__id__</code>) is inaccessible on a moved object.</p>

<h2 id="class-Ractor-label-Ractors+vs+threads">Ractors vs threads<span><a href="#class-Ractor-label-Ractors+vs+threads">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Each ractor creates its own thread. New threads can be created from inside ractor, sharing GVL with other threads of this ractor, and having access to its data.</p>

<pre class="ruby"><span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> {
  <span class="ruby-identifier">a</span> = <span class="ruby-value">1</span>
  <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> { <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Thread in ractor: a=#{a}&quot;</span> }.<span class="ruby-identifier">join</span>
}
<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)
<span class="ruby-comment"># Here &quot;Thread in ractor: a=1&quot; will be printed</span>
</pre>

  </section>


  <section id="5Buntitled-5D" class="documentation-section">









     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>


      <div id="method-c-count" class="method-detail ">

        <div class="method-heading">
          <span class="method-name">count</span><span
            class="method-args">()</span>

          <span class="method-click-advice">click to toggle source</span>

        </div>


        <div class="method-description">

          <p>Returns total count of Ractors currently running.</p>

<pre class="ruby"><span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">count</span>                   <span class="ruby-comment">#=&gt; 1</span>
<span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> { <span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>) }
<span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">count</span>                   <span class="ruby-comment">#=&gt; 2</span>
<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)                     <span class="ruby-comment"># wait till r will finish</span>
<span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">count</span>                   <span class="ruby-comment">#=&gt; 1</span>
</pre>




          <div class="method-source-code" id="count-source">
            <pre><span class="ruby-comment"># File ractor.rb, line 206</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">count</span>
  <span class="ruby-identifier">__builtin_cexpr!</span> <span class="ruby-string">%q{
    ULONG2NUM(GET_VM()-&gt;ractor.cnt);
  }</span>
<span class="ruby-keyword">end</span></pre>
          </div>

        </div>




      </div>


      <div id="method-c-current" class="method-detail ">

        <div class="method-heading">
          <span class="method-name">current</span><span
            class="method-args">()</span>

          <span class="method-click-advice">click to toggle source</span>

        </div>


        <div class="method-description">

          <p>Returns the currently executing <a href="Ractor.html"><code>Ractor</code></a>.</p>

<pre class="ruby"><span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">current</span> <span class="ruby-comment">#=&gt; #&lt;Ractor:#1 running&gt;</span>
</pre>




          <div class="method-source-code" id="current-source">
            <pre><span class="ruby-comment"># File ractor.rb, line 193</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">current</span>
  <span class="ruby-identifier">__builtin_cexpr!</span> <span class="ruby-string">%q{
    rb_ec_ractor_ptr(ec)-&gt;self
  }</span>
<span class="ruby-keyword">end</span></pre>
          </div>

        </div>




      </div>


      <div id="method-c-make_shareable" class="method-detail ">

        <div class="method-heading">
          <span class="method-name">make_shareable</span><span
            class="method-args">(obj)</span>

          <span class="method-click-advice">click to toggle source</span>

        </div>


        <div class="method-description">

          <p>Tries to make object shareable by ractors, if it is not. Typically, it means deeply freezing it.</p>

<pre class="ruby"><span class="ruby-identifier">obj</span> = [<span class="ruby-string">+&#39;test&#39;</span>]            <span class="ruby-comment"># an array with unfrozen string inside</span>
<span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">shareable?</span>(<span class="ruby-identifier">obj</span>)     <span class="ruby-comment">#=&gt; false</span>
<span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">make_shareable</span>(<span class="ruby-identifier">obj</span>) <span class="ruby-comment">#=&gt; [&quot;test&quot;]</span>
<span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">shareable?</span>(<span class="ruby-identifier">obj</span>)     <span class="ruby-comment">#=&gt; true</span>
<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">frozen?</span>                <span class="ruby-comment">#=&gt; true</span>
<span class="ruby-identifier">obj</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">frozen?</span>             <span class="ruby-comment">#=&gt; true</span>
</pre>

<p>See also the “Shareable and unshareable objects” section in the <a href="Ractor.html"><code>Ractor</code></a> class docs.</p>




          <div class="method-source-code" id="make_shareable-source">
            <pre><span class="ruby-comment"># File ractor.rb, line 569</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">make_shareable</span> <span class="ruby-identifier">obj</span>
  <span class="ruby-identifier">__builtin_cexpr!</span> <span class="ruby-string">%q{
    rb_ractor_make_shareable(obj);
  }</span>
<span class="ruby-keyword">end</span></pre>
          </div>

        </div>




      </div>


      <div id="method-c-new" class="method-detail ">

        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">(*args, name: nil, &amp;block)</span>

          <span class="method-click-advice">click to toggle source</span>

        </div>


        <div class="method-description">

          <p>Create a new <a href="Ractor.html"><code>Ractor</code></a> with args and a block.</p>

<p>A block (Proc) will be isolated (can&#39;t access to outer variables). <code>self</code> inside the block will refer to the current <a href="Ractor.html"><code>Ractor</code></a>.</p>

<pre class="ruby"><span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> { <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Hi, I am #{self.inspect}&quot;</span> }
<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)
<span class="ruby-comment"># Prints &quot;Hi, I am #&lt;Ractor:#2 test.rb:1 running&gt;&quot;</span>
</pre>

<p><code>args</code> passed to the method would be propagated to block args by the same rules as objects passed through <a href="Ractor.html#method-i-send"><code>send</code></a>/Ractor.receive: if <code>args</code> are not shareable, they will be copied (via <a href="Marshal.html"><code>Marshal</code></a>, which might be ineffective).</p>

<pre class="ruby"><span class="ruby-identifier">arg</span> = [<span class="ruby-value">1</span>, <span class="ruby-value">2</span>, <span class="ruby-value">3</span>]
<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Passing: #{arg} (##{arg.object_id})&quot;</span>
<span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">arg</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">received_arg</span><span class="ruby-operator">|</span>
 <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Received: #{received_arg} (##{received_arg.object_id})&quot;</span>
}
<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)
<span class="ruby-comment"># Prints:</span>
<span class="ruby-comment"># Passing: [1, 2, 3] (#280)</span>
<span class="ruby-comment"># Received: [1, 2, 3] (#300)</span>
</pre>

<p>Ractor&#39;s <code>name</code> can be set for debugging purposes:</p>

<pre class="ruby"><span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">name:</span> <span class="ruby-string">&#39;dummy&#39;</span>) {}
<span class="ruby-identifier">p</span> <span class="ruby-identifier">r</span>
<span class="ruby-comment">#=&gt; #&lt;Ractor:#3 dummy test.rb:1 terminated&gt;</span>
</pre>




          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File ractor.rb, line 182</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">new</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-value">name:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
  <span class="ruby-identifier">b</span> = <span class="ruby-identifier">block</span> <span class="ruby-comment"># TODO: builtin bug</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;must be called with a block&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">block</span>
  <span class="ruby-identifier">loc</span> = <span class="ruby-identifier">caller_locations</span>(<span class="ruby-value">1</span>, <span class="ruby-value">1</span>).<span class="ruby-identifier">first</span>
  <span class="ruby-identifier">loc</span> = <span class="ruby-node">&quot;#{loc.path}:#{loc.lineno}&quot;</span>
  <span class="ruby-identifier">__builtin_ractor_create</span>(<span class="ruby-identifier">loc</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">args</span>, <span class="ruby-identifier">b</span>)
<span class="ruby-keyword">end</span></pre>
          </div>

        </div>




      </div>


      <div id="method-c-receive" class="method-detail ">

        <div class="method-heading">
          <span class="method-name">receive</span><span
            class="method-args">()</span>

          <span class="method-click-advice">click to toggle source</span>

        </div>


        <div class="method-description">

          <p>Receive an incoming message from the current Ractor&#39;s incoming port&#39;s queue, which was sent there by <a href="Ractor.html#method-i-send"><code>send</code></a>.</p>

<pre class="ruby"><span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> {
  <span class="ruby-identifier">v1</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">receive</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Received: #{v1}&quot;</span>
}
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">send</span>(<span class="ruby-string">&#39;message1&#39;</span>)
<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)
<span class="ruby-comment"># Here will be printed: &quot;Received: message1&quot;</span>
</pre>

<p>The method blocks if the queue is empty.</p>

<pre class="ruby"><span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> {
  <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Before first receive&quot;</span>
  <span class="ruby-identifier">v1</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">receive</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Received: #{v1}&quot;</span>
  <span class="ruby-identifier">v2</span> = <span class="ruby-identifier">receive</span> <span class="ruby-comment"># self.receive is an synonym for Ractor.receive</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Received: #{v2}&quot;</span>
}
<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)
<span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Still not received&quot;</span>
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">send</span>(<span class="ruby-string">&#39;message1&#39;</span>)
<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)
<span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Still received only one&quot;</span>
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">send</span>(<span class="ruby-string">&#39;message2&#39;</span>)
<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)
</pre>

<p>Output:</p>

<pre>Before first receive
Still not received
Received: message1
Still received only one
Received: message2</pre>

<p>If <a href="Ractor.html#method-i-close_incoming"><code>close_incoming</code></a> was called on the ractor, the method raises Ractor::ClosedError:</p>

<pre class="ruby"><span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> {
  <span class="ruby-identifier">close_incoming</span>
  <span class="ruby-identifier">receive</span>
}
<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)
<span class="ruby-comment"># in `receive&#39;: The incoming port is already closed =&gt; #&lt;Ractor:#2 test.rb:1 running&gt; (Ractor::ClosedError)</span>
</pre>




          <div class="method-source-code" id="receive-source">
            <pre><span class="ruby-comment"># File ractor.rb, line 317</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">receive</span>
  <span class="ruby-identifier">__builtin_cexpr!</span> <span class="ruby-string">%q{
    ractor_receive(ec, rb_ec_ractor_ptr(ec))
  }</span>
<span class="ruby-keyword">end</span></pre>
          </div>

        </div>


        <div class="aliases">
          Also aliased as: <a href="Ractor.html#method-c-recv">recv</a>
        </div>



      </div>


      <div id="method-c-recv" class="method-detail method-alias">

        <div class="method-heading">
          <span class="method-name">recv</span><span
            class="method-args">()</span>

        </div>


        <div class="method-description">






        </div>




        <div class="aliases">
          Alias for: <a href="Ractor.html#method-c-receive">receive</a>
        </div>

      </div>


      <div id="method-c-select" class="method-detail ">


        <div class="method-heading">
          <span class="method-callseq">
            select(*ractors, [yield_value:, move: false]) &rarr; [ractor or symbol, obj]
          </span>

          <span class="method-click-advice">click to toggle source</span>

        </div>



        <div class="method-description">

          <p>Wait for the first ractor to have something in its outgoing port, reads from this ractor, and returns that ractor and the object received.</p>

<pre class="ruby"><span class="ruby-identifier">r1</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> { <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">yield</span> <span class="ruby-string">&#39;from 1&#39;</span> }
<span class="ruby-identifier">r2</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> { <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">yield</span> <span class="ruby-string">&#39;from 2&#39;</span> }

<span class="ruby-identifier">r</span>, <span class="ruby-identifier">obj</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">select</span>(<span class="ruby-identifier">r1</span>, <span class="ruby-identifier">r2</span>)

<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;received #{obj.inspect} from #{r.inspect}&quot;</span>
<span class="ruby-comment"># Prints: received &quot;from 1&quot; from #&lt;Ractor:#2 test.rb:1 running&gt;</span>
</pre>

<p>If one of the ractor&#39;s awaited is the current ractor, and it would be selected, <code>r</code> will contain <code>:receive</code> symbol instead of the ractor object.</p>

<pre class="ruby"><span class="ruby-identifier">r1</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">current</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">main</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">main</span>.<span class="ruby-identifier">send</span> <span class="ruby-string">&#39;to main&#39;</span>
  <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">yield</span> <span class="ruby-string">&#39;from 1&#39;</span>
}
<span class="ruby-identifier">r2</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> {
  <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">yield</span> <span class="ruby-string">&#39;from 2&#39;</span>
}

<span class="ruby-identifier">r</span>, <span class="ruby-identifier">obj</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">select</span>(<span class="ruby-identifier">r1</span>, <span class="ruby-identifier">r2</span>, <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">current</span>)
<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;received #{obj.inspect} from #{r.inspect}&quot;</span>
<span class="ruby-comment"># Prints: received &quot;to main&quot; from :receive</span>
</pre>

<p>If <code>yield_value</code> is provided, it is yielded (with <a href="Ractor.html#method-c-yield"><code>Ractor.yield</code></a>) if no ractor is selected. In this case, the pair <code>[:yield, nil]</code> would be returned:</p>

<pre class="ruby"><span class="ruby-identifier">r1</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">current</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">main</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Received from main: #{main.take}&quot;</span>
}

<span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Trying to select&quot;</span>
<span class="ruby-identifier">r</span>, <span class="ruby-identifier">obj</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">select</span>(<span class="ruby-identifier">r1</span>, <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">current</span>, <span class="ruby-value">yield_value:</span> <span class="ruby-value">123</span>)
<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)
<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Received #{obj.inspect} from #{r.inspect}&quot;</span>
</pre>

<p>This will print:</p>

<pre>Trying to select
Received from main: 123
Received nil from :yield</pre>

<p><code>move</code> boolean flag defines whether yielded value should be copied (default) or moved.</p>




          <div class="method-source-code" id="select-source">
            <pre><span class="ruby-comment"># File ractor.rb, line 259</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">select</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">ractors</span>, <span class="ruby-value">yield_value:</span> <span class="ruby-identifier">yield_unspecified</span> = <span class="ruby-keyword">true</span>, <span class="ruby-value">move:</span> <span class="ruby-keyword">false</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&#39;specify at least one ractor or `yield_value`&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">yield_unspecified</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ractors</span>.<span class="ruby-identifier">empty?</span>

  <span class="ruby-identifier">__builtin_cstmt!</span> <span class="ruby-string">%q{
    const VALUE *rs = RARRAY_CONST_PTR_TRANSIENT(ractors);
    VALUE rv;
    VALUE v = ractor_select(ec, rs, RARRAY_LENINT(ractors),
                            yield_unspecified == Qtrue ? Qundef : yield_value,
                            (bool)RTEST(move) ? true : false, &amp;rv);
    return rb_ary_new_from_args(2, rv, v);
  }</span>
<span class="ruby-keyword">end</span></pre>
          </div>

        </div>




      </div>


      <div id="method-c-shareable-3F" class="method-detail ">

        <div class="method-heading">
          <span class="method-name">shareable?</span><span
            class="method-args">(obj)</span>

          <span class="method-click-advice">click to toggle source</span>

        </div>


        <div class="method-description">

          <p>Checks if the object is shareable by ractors.</p>

<pre class="ruby"><span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">shareable?</span>(<span class="ruby-value">1</span>)        <span class="ruby-comment">#=&gt; true -- numbers and other immutable basic values are</span>
<span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">shareable?</span>(<span class="ruby-string">&#39;foo&#39;</span>)    <span class="ruby-comment">#=&gt; true or false, depending on whether you have freeze_string_literals: true</span>
<span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">shareable?</span>(<span class="ruby-string">-&#39;foo&#39;</span>)   <span class="ruby-comment">#=&gt; true</span>
<span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">shareable?</span>(<span class="ruby-string">+&#39;foo&#39;</span>)   <span class="ruby-comment">#=&gt; false</span>
</pre>

<p>See also the “Shareable and unshareable objects” section in the <a href="Ractor.html"><code>Ractor</code></a> class docs.</p>




          <div class="method-source-code" id="shareable-3F-source">
            <pre><span class="ruby-comment"># File ractor.rb, line 552</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">shareable?</span> <span class="ruby-identifier">obj</span>
  <span class="ruby-identifier">__builtin_cexpr!</span> <span class="ruby-string">%q{
    rb_ractor_shareable_p(obj) ? Qtrue : Qfalse;
  }</span>
<span class="ruby-keyword">end</span></pre>
          </div>

        </div>




      </div>


      <div id="method-c-yield" class="method-detail ">

        <div class="method-heading">
          <span class="method-name">yield</span><span
            class="method-args">(obj, move: false)</span>

          <span class="method-click-advice">click to toggle source</span>

        </div>


        <div class="method-description">

          <p>Send a message to the current ractor&#39;s outgoing port to be consumed by <a href="Ractor.html#method-i-take"><code>take</code></a>.</p>

<pre class="ruby"><span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> { <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">yield</span> <span class="ruby-string">&#39;Hello from ractor&#39;</span> }
<span class="ruby-identifier">puts</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">take</span>
<span class="ruby-comment"># Prints: &quot;Hello from ractor&quot;</span>
</pre>

<p>The method is blocking, and will return only when somebody will consume the sent message.</p>

<pre class="ruby"><span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> {
  <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">yield</span> <span class="ruby-string">&#39;Hello from ractor&#39;</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Ractor: after yield&quot;</span>
}
<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)
<span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Still not taken&quot;</span>
<span class="ruby-identifier">puts</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">take</span>
</pre>

<p>This will print:</p>

<pre>Still not taken
Hello from ractor
Ractor: after yield</pre>

<p>If the outgoing port was closed with <a href="Ractor.html#method-i-close_outgoing"><code>close_outgoing</code></a>, the method will raise:</p>

<pre class="ruby"><span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> {
  <span class="ruby-identifier">close_outgoing</span>
  <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">yield</span> <span class="ruby-string">&#39;Hello from ractor&#39;</span>
}
<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)
<span class="ruby-comment"># `yield&#39;: The outgoing-port is already closed (Ractor::ClosedError)</span>
</pre>

<p>The meaning of <code>move</code> argument is the same as for <a href="Ractor.html#method-i-send"><code>send</code></a>.</p>




          <div class="method-source-code" id="yield-source">
            <pre><span class="ruby-comment"># File ractor.rb, line 446</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-keyword">yield</span>(<span class="ruby-identifier ruby-title">obj</span>, <span class="ruby-value">move:</span> <span class="ruby-keyword">false</span>)
  <span class="ruby-identifier">__builtin_cexpr!</span> <span class="ruby-string">%q{
    ractor_yield(ec, rb_ec_ractor_ptr(ec), obj, move)
  }</span>
<span class="ruby-keyword">end</span></pre>
          </div>

        </div>




      </div>


    </section>

     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>


      <div id="method-i-3C-3C" class="method-detail method-alias">

        <div class="method-heading">
          <span class="method-name">&lt;&lt;</span><span
            class="method-args">(obj, move: false)</span>

        </div>


        <div class="method-description">






        </div>




        <div class="aliases">
          Alias for: <a href="Ractor.html#method-i-send">send</a>
        </div>

      </div>


      <div id="method-i-close_incoming" class="method-detail ">

        <div class="method-heading">
          <span class="method-name">close_incoming</span><span
            class="method-args">()</span>

          <span class="method-click-advice">click to toggle source</span>

        </div>


        <div class="method-description">

          <p>Closes the incoming port and returns its previous state. All further attempts to <a href="Ractor.html#method-c-receive"><code>Ractor.receive</code></a> in the ractor, and <a href="Ractor.html#method-i-send"><code>send</code></a> to the ractor will fail with <a href="Ractor/ClosedError.html"><code>Ractor::ClosedError</code></a>.</p>

<pre class="ruby"><span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> { <span class="ruby-identifier">sleep</span>(<span class="ruby-value">500</span>) }
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">close_incoming</span>  <span class="ruby-comment">#=&gt; false</span>
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">close_incoming</span>  <span class="ruby-comment">#=&gt; true</span>
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">send</span>(<span class="ruby-string">&#39;test&#39;</span>)
<span class="ruby-comment"># Ractor::ClosedError (The incoming-port is already closed)</span>
</pre>




          <div class="method-source-code" id="close_incoming-source">
            <pre><span class="ruby-comment"># File ractor.rb, line 523</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">close_incoming</span>
  <span class="ruby-identifier">__builtin_cexpr!</span> <span class="ruby-string">%q{
    ractor_close_incoming(ec, RACTOR_PTR(self));
  }</span>
<span class="ruby-keyword">end</span></pre>
          </div>

        </div>




      </div>


      <div id="method-i-close_outgoing" class="method-detail ">

        <div class="method-heading">
          <span class="method-name">close_outgoing</span><span
            class="method-args">()</span>

          <span class="method-click-advice">click to toggle source</span>

        </div>


        <div class="method-description">

          <p>Closes the outgoing port and returns its previous state. All further attempts to <a href="Ractor.html#method-c-yield"><code>Ractor.yield</code></a> in the ractor, and <a href="Ractor.html#method-i-take"><code>take</code></a> from the ractor will fail with <a href="Ractor/ClosedError.html"><code>Ractor::ClosedError</code></a>.</p>

<pre class="ruby"><span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> { <span class="ruby-identifier">sleep</span>(<span class="ruby-value">500</span>) }
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">close_outgoing</span>  <span class="ruby-comment">#=&gt; false</span>
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">close_outgoing</span>  <span class="ruby-comment">#=&gt; true</span>
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">take</span>
<span class="ruby-comment"># Ractor::ClosedError (The outgoing-port is already closed)</span>
</pre>




          <div class="method-source-code" id="close_outgoing-source">
            <pre><span class="ruby-comment"># File ractor.rb, line 538</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">close_outgoing</span>
  <span class="ruby-identifier">__builtin_cexpr!</span> <span class="ruby-string">%q{
    ractor_close_outgoing(ec, RACTOR_PTR(self));
  }</span>
<span class="ruby-keyword">end</span></pre>
          </div>

        </div>




      </div>


      <div id="method-i-name" class="method-detail ">

        <div class="method-heading">
          <span class="method-name">name</span><span
            class="method-args">()</span>

          <span class="method-click-advice">click to toggle source</span>

        </div>


        <div class="method-description">

          <p>The name set in <a href="Ractor.html#method-c-new"><code>Ractor.new</code></a>, or <code>nil</code>.</p>




          <div class="method-source-code" id="name-source">
            <pre><span class="ruby-comment"># File ractor.rb, line 506</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">name</span>
  <span class="ruby-identifier">__builtin_cexpr!</span> <span class="ruby-string">%q{ RACTOR_PTR(self)-&gt;name }</span>
<span class="ruby-keyword">end</span></pre>
          </div>

        </div>




      </div>


      <div id="method-i-recv" class="method-detail method-alias">

        <div class="method-heading">
          <span class="method-name">recv</span><span
            class="method-args">()</span>

        </div>


        <div class="method-description">






        </div>




        <div class="aliases">
          Alias for: <a href="Ractor.html#method-i-receive">receive</a>
        </div>

      </div>


      <div id="method-i-send" class="method-detail ">

        <div class="method-heading">
          <span class="method-name">send</span><span
            class="method-args">(obj, move: false)</span>

          <span class="method-click-advice">click to toggle source</span>

        </div>


        <div class="method-description">

          <p>Send a message to a Ractor&#39;s incoming queue to be consumed by <a href="Ractor.html#method-c-receive"><code>Ractor.receive</code></a>.</p>

<pre class="ruby"><span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">value</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">receive</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Received #{value}&quot;</span>
<span class="ruby-keyword">end</span>
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">send</span> <span class="ruby-string">&#39;message&#39;</span>
<span class="ruby-comment"># Prints: &quot;Received: message&quot;</span>
</pre>

<p>The method is non-blocking (will return immediately even if the ractor is not ready to receive anything):</p>

<pre class="ruby"><span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> { <span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>) }
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">send</span>(<span class="ruby-string">&#39;test&#39;</span>)
<span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Sent successfully&quot;</span>
<span class="ruby-comment"># Prints: &quot;Sent successfully&quot; immediately</span>
</pre>

<p>If <a href="Ractor.html#method-i-close_incoming"><code>close_incoming</code></a> was called on the ractor, the method raises <a href="Ractor/ClosedError.html"><code>Ractor::ClosedError</code></a>.</p>

<pre class="ruby"><span class="ruby-identifier">r</span> =  <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> {
  <span class="ruby-identifier">sleep</span>(<span class="ruby-value">500</span>)
  <span class="ruby-identifier">receive</span>
}
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">close_incoming</span>
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">send</span>(<span class="ruby-string">&#39;test&#39;</span>)
<span class="ruby-comment"># Ractor::ClosedError (The incoming-port is already closed)</span>
<span class="ruby-comment"># The error would be raised immediately, not when ractor will try to receive</span>
</pre>

<p>Attempt to send to ractor which already finished its execution results in the same error:</p>

<pre class="ruby"><span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> {}
<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)
<span class="ruby-identifier">p</span> <span class="ruby-identifier">r</span>
<span class="ruby-comment"># &quot;#&lt;Ractor:#6 (irb):23 terminated&gt;&quot;</span>
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">send</span>(<span class="ruby-string">&#39;test&#39;</span>)
<span class="ruby-comment"># Ractor::ClosedError (The incoming-port is already closed)</span>
</pre>

<p>If the <code>obj</code> is unshareable, by default it would be copied into ractor with <a href="Marshal.html"><code>Marshal</code></a>. If the <code>move: true</code> is passed, object is <em>moved</em> into ractor and becomes inaccessible to sender.</p>

<pre class="ruby"><span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> { <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Received: #{receive}&quot;</span> }
<span class="ruby-identifier">msg</span> = <span class="ruby-string">+&#39;message&#39;</span> <span class="ruby-comment"># create non-frozen string</span>
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">msg</span>, <span class="ruby-value">move:</span> <span class="ruby-keyword">true</span>)
<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)
<span class="ruby-identifier">p</span> <span class="ruby-identifier">msg</span>
</pre>

<p>This prints:</p>

<pre>Receieved: message
in `p&#39;: undefined method `inspect&#39; for #&lt;Ractor::MovedObject:0x000055c99b9b69b8&gt;</pre>

<p>All references to the object and its parts will become invalid in sender.</p>

<pre class="ruby"><span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> { <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Received: #{receive}&quot;</span> }
<span class="ruby-identifier">s</span> = <span class="ruby-string">+&#39;message&#39;</span>
<span class="ruby-identifier">ary</span> = [<span class="ruby-identifier">s</span>]
<span class="ruby-identifier">copy</span> = <span class="ruby-identifier">ary</span>.<span class="ruby-identifier">dup</span>
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">ary</span>, <span class="ruby-value">move:</span> <span class="ruby-keyword">true</span>)
<span class="ruby-identifier">sleep</span>(<span class="ruby-value">0.1</span>)

<span class="ruby-identifier">s</span>.<span class="ruby-identifier">inspect</span>
<span class="ruby-comment"># Ractor::MovedError (can not send any methods to a moved object)</span>
<span class="ruby-identifier">ary</span>.<span class="ruby-identifier">class</span>
<span class="ruby-comment"># Ractor::MovedError (can not send any methods to a moved object)</span>
<span class="ruby-identifier">copy</span>.<span class="ruby-identifier">class</span>
<span class="ruby-comment"># =&gt; Array, it is different object</span>
<span class="ruby-identifier">copy</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">inspect</span>
<span class="ruby-comment"># Ractor::MovedError (can not send any methods to a moved object)</span>
<span class="ruby-comment"># ...but its item was still a reference to `s`, which was moved</span>
</pre>




          <div class="method-source-code" id="send-source">
            <pre><span class="ruby-comment"># File ractor.rb, line 406</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">send</span>(<span class="ruby-identifier">obj</span>, <span class="ruby-value">move:</span> <span class="ruby-keyword">false</span>)
  <span class="ruby-identifier">__builtin_cexpr!</span> <span class="ruby-string">%q{
    ractor_send(ec, RACTOR_PTR(self), obj, move)
  }</span>
<span class="ruby-keyword">end</span></pre>
          </div>

        </div>


        <div class="aliases">
          Also aliased as: <a href="Ractor.html#method-i-3C-3C">&lt;&lt;</a>
        </div>



      </div>


      <div id="method-i-take" class="method-detail ">

        <div class="method-heading">
          <span class="method-name">take</span><span
            class="method-args">()</span>

          <span class="method-click-advice">click to toggle source</span>

        </div>


        <div class="method-description">

          <p>Take a message from ractor&#39;s outgoing port, which was put there by <a href="Ractor.html#method-c-yield"><code>Ractor.yield</code></a> or at ractor&#39;s finalization.</p>

<pre class="ruby"><span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> {
  <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">yield</span> <span class="ruby-string">&#39;explicit yield&#39;</span>
  <span class="ruby-string">&#39;last value&#39;</span>
}
<span class="ruby-identifier">puts</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">take</span> <span class="ruby-comment">#=&gt; &#39;explicit yield&#39;</span>
<span class="ruby-identifier">puts</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">take</span> <span class="ruby-comment">#=&gt; &#39;last value&#39;</span>
<span class="ruby-identifier">puts</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">take</span> <span class="ruby-comment"># Ractor::ClosedError (The outgoing-port is already closed)</span>
</pre>

<p>The fact that the last value is also put to outgoing port means that <code>take</code> can be used as some analog of <a href="Thread.html#method-i-join"><code>Thread#join</code></a> (“just wait till ractor finishes”), but don&#39;t forget it will raise if somebody had already consumed everything ractor have produced.</p>

<p>If the outgoing port was closed with <a href="Ractor.html#method-i-close_outgoing"><code>close_outgoing</code></a>, the method will raise <a href="Ractor/ClosedError.html"><code>Ractor::ClosedError</code></a>.</p>

<pre class="ruby"><span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> {
  <span class="ruby-identifier">sleep</span>(<span class="ruby-value">500</span>)
  <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">yield</span> <span class="ruby-string">&#39;Hello from ractor&#39;</span>
}
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">close_outgoing</span>
<span class="ruby-identifier">r</span>.<span class="ruby-identifier">take</span>
<span class="ruby-comment"># Ractor::ClosedError (The outgoing-port is already closed)</span>
<span class="ruby-comment"># The error would be raised immediately, not when ractor will try to receive</span>
</pre>

<p>If the exception have happened in the <a href="Ractor.html"><code>Ractor</code></a>, it is propagated on take as a <a href="Ractor/RemoteError.html"><code>Ractor::RemoteError</code></a>.</p>

<pre class="ruby"><span class="ruby-identifier">r</span> = <span class="ruby-constant">Ractor</span>.<span class="ruby-identifier">new</span> { <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Something weird happened&quot;</span> }

<span class="ruby-keyword">begin</span>
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">take</span>
<span class="ruby-keyword">rescue</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
  <span class="ruby-identifier">p</span> <span class="ruby-identifier">e</span>         <span class="ruby-comment"># =&gt; #&lt;Ractor::RemoteError: thrown by remote Ractor.&gt;</span>
  <span class="ruby-identifier">p</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">ractor</span>  <span class="ruby-comment"># =&gt; #&lt;Ractor:#2 test.rb:1 terminated&gt;</span>
  <span class="ruby-identifier">p</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">cause</span>   <span class="ruby-comment"># =&gt; #&lt;RuntimeError: Something weird happened&gt;</span>
<span class="ruby-keyword">end</span>
</pre>




          <div class="method-source-code" id="take-source">
            <pre><span class="ruby-comment"># File ractor.rb, line 489</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">take</span>
  <span class="ruby-identifier">__builtin_cexpr!</span> <span class="ruby-string">%q{
    ractor_take(ec, RACTOR_PTR(self))
  }</span>
<span class="ruby-keyword">end</span></pre>
          </div>

        </div>




      </div>


    </section>

  </section>

</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.1.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

